# üêç Playwright API Testing com Python + Pytest (ServeRest)

Su√≠te de testes de API escrita em Python usando **Playwright**, **Pytest** e **Allure**, cobrindo os principais fluxos da API [ServeRest](https://serverest.dev/?lang=pt-BR).

---

## Estrutura do projeto

```
tests/
‚îú‚îÄ‚îÄ conftest.py                        # Fixtures globais (sess√£o Playwright e APIRequestContext)
‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îî‚îÄ‚îÄ test_login_playwright.py       # CT01 a CT05
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îî‚îÄ‚îÄ test_users_playwright.py       # CT01 a CT16
‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îî‚îÄ‚îÄ test_products_playwright.py    # CT01 a CT13
‚îú‚îÄ‚îÄ carts/
‚îÇ   ‚îî‚îÄ‚îÄ test_carts_playwright.py       # CT01 a CT08
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îú‚îÄ‚îÄ login/                         # CSVs com payloads de login inv√°lidos
‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ productPayload.json
‚îÇ   ‚îî‚îÄ‚îÄ users/
‚îÇ       ‚îî‚îÄ‚îÄ userPayload.json
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ api_utils.py                   # Helpers HTTP: post_json, put_json, parse_response_body, load_json_resource
    ‚îî‚îÄ‚îÄ faker_utils.py                 # Geradores de dados: random_name, random_email, random_product
__snapshots/                           # Snapshots gerados pelo assertpy para compara√ß√£o de respostas
allure-results/                        # Sa√≠da gerada pelo pytest para o Allure Report
pytest.ini                             # Configura√ß√£o do Pytest (marcadores, diret√≥rio de resultados Allure etc.)
requirements.txt                       # Depend√™ncias do projeto
```

---

## Depend√™ncias principais

| Pacote            | Vers√£o  | Finalidade                                |
|-------------------|---------|-------------------------------------------|
| `pytest`          | 8.4.2   | Framework de testes                       |
| `playwright`      | 1.58.0  | Cliente HTTP via `APIRequestContext`      |
| `allure-pytest`   | 2.15.3  | Integra√ß√£o com relat√≥rios Allure          |
| `assertpy`        | 1.1     | Assertions fluentes                       |
| `pytest-xdist`    | 3.8.0   | Execu√ß√£o paralela de testes               |

---

## Pr√©-requisitos

- Python 3.11+
- Depend√™ncias listadas em `requirements.txt`

---

## Instala√ß√£o

```bash
python -m pip install -r requirements.txt
python -m playwright install
```

---

## Execu√ß√£o

### Su√≠te completa

```bash
pytest tests
```

### Por m√≥dulo

```bash
pytest tests/login/test_login_playwright.py
pytest tests/users/test_users_playwright.py
pytest tests/products/test_products_playwright.py
pytest tests/carts/test_carts_playwright.py
```

### Em paralelo (pytest-xdist)

```bash
pytest tests -n auto
```

### Gerando relat√≥rio Allure

```bash
# Executar testes e salvar resultados
pytest tests --alluredir=allure-results

# Abrir relat√≥rio interativo no browser
allure serve allure-results
```

---

## Fixtures (conftest.py)

| Fixture               | Escopo    | Descri√ß√£o                                                         |
|-----------------------|-----------|-------------------------------------------------------------------|
| `playwright_instance` | `session` | Inst√¢ncia √∫nica do Playwright reutilizada em toda a sess√£o        |
| `api_request`         | `function`| `APIRequestContext` com `base_url=https://serverest.dev`, descartado ap√≥s cada teste |

---

## assert_that (assertpy)

Todos os testes usam `assert_that` da biblioteca [assertpy](https://github.com/assertpy/assertpy) para realizar asser√ß√µes fluentes e leg√≠veis.

### Importa√ß√£o

```python
from assertpy import assert_that
```

### Asser√ß√µes mais utilizadas neste projeto

| M√©todo                            | O que valida                                          |
|-----------------------------------|-------------------------------------------------------|
| `.is_equal_to(value)`             | Igualdade exata                                       |
| `.is_not_equal_to(value)`         | Diferen√ßa entre valores                               |
| `.is_not_none()`                  | Valor n√£o √© `None`                                    |
| `.is_none()`                      | Valor √© `None`                                        |
| `.contains(substr)`               | String ou lista cont√©m o valor informado              |
| `.does_not_contain(substr)`       | String ou lista n√£o cont√©m o valor                    |
| `.is_true()` / `.is_false()`      | Booleano verdadeiro / falso                           |
| `.is_greater_than(n)`             | Num√©rico maior que `n`                                |
| `.is_less_than(n)`                | Num√©rico menor que `n`                                |
| `.is_between(a, b)`               | Num√©rico dentro do intervalo `[a, b]`                 |
| `.is_length(n)`                   | Sequ√™ncia com tamanho exato `n`                       |
| `.is_empty()` / `.is_not_empty()` | Sequ√™ncia vazia ou n√£o vazia                          |
| `.has_size(n)`                    | Cole√ß√£o com `n` elementos                             |
| `.snapshot()`                     | Compara com snapshot salvo em `__snapshots/` (ver abaixo) |

### Exemplo de uso

```python
from assertpy import assert_that

resp = api_request.get("/usuarios")
assert_that(resp.status).is_equal_to(200)

body = resp.json()
assert_that(body.get("quantidade")).is_greater_than(0)
assert_that(body.get("usuarios")).is_not_empty()
```

### Snapshot testing

O m√©todo `.snapshot()` salva a resposta na primeira execu√ß√£o e nas execu√ß√µes seguintes verifica se o conte√∫do √© id√™ntico ao snapshot armazenado. Os arquivos ficam em `__snapshots/`.

```python
body = parse_response_body(resp)
assert_that(body).snapshot()   # cria ou valida __snapshots/<nome-do-arquivo>.json
```

> Para atualizar um snapshot existente, apague o arquivo correspondente em `__snapshots/` e execute o teste novamente.

### Encadeamento de asser√ß√µes

```python
assert_that(body["message"]) \
    .is_not_none() \
    .contains("sucesso")
```

---

## Allure Report ‚Äî decorators dispon√≠veis no Python

O `allure-pytest` oferece decorators e helpers para enriquecer o relat√≥rio gerado. Abaixo est√£o todas as anota√ß√µes dispon√≠veis.

### Decorators de n√≠vel de teste / fun√ß√£o

| Decorator                               | Descri√ß√£o                                             | Exemplo                                            |
|-----------------------------------------|-------------------------------------------------------|----------------------------------------------------|
| `@allure.severity(level)`               | Define a criticidade do teste (ver tabela abaixo)     | `@allure.severity(allure.severity_level.CRITICAL)` |
| `@allure.title("T√≠tulo")`               | T√≠tulo leg√≠vel exibido no relat√≥rio                   | `@allure.title("CT01 - Login v√°lido")`             |
| `@allure.description("Descri√ß√£o")`      | Descri√ß√£o longa do teste                              | `@allure.description("Valida token JWT retornado")`|
| `@allure.description_html("html")`      | Descri√ß√£o em HTML                                     | `@allure.description_html("<b>Login</b>")`         |
| `@allure.feature("Feature")`            | Agrupa testes por funcionalidade                      | `@allure.feature("Login")`                         |
| `@allure.story("Story")`                | Subdivide features em hist√≥rias                       | `@allure.story("Login com credenciais v√°lidas")`   |
| `@allure.epic("Epic")`                  | Agrupa features em √©picos (maior granularidade)       | `@allure.epic("Autentica√ß√£o")`                     |
| `@allure.tag("tag1", "tag2")`           | Tags livres para categoriza√ß√£o                        | `@allure.tag("smoke", "regression")`               |
| `@allure.label("name", "value")`        | Label customizado de formato chave-valor              | `@allure.label("layer", "api")`                    |
| `@allure.link(url, name="texto")`       | Link gen√©rico no relat√≥rio                            | `@allure.link("https://serverest.dev")`            |
| `@allure.issue(url, name="texto")`      | Link para issue/bug tracker                           | `@allure.issue("https://github.com/org/repo/1")`  |
| `@allure.testcase(url, name="texto")`   | Link para caso de teste em ferramenta de gest√£o       | `@allure.testcase("https://jira.example.com/TC-1")`|

### N√≠veis de severidade (`allure.severity_level`)

| Constante                          | Uso                                        |
|------------------------------------|--------------------------------------------|
| `allure.severity_level.BLOCKER`    | Impede a execu√ß√£o; bloqueia o release      |
| `allure.severity_level.CRITICAL`   | Fluxo principal; falha impacta diretamente |
| `allure.severity_level.NORMAL`     | Importante, mas n√£o bloqueia o fluxo core  |
| `allure.severity_level.MINOR`      | Pouco impacto; melhoria ou detalhe         |
| `allure.severity_level.TRIVIAL`    | Cosm√©tico ou edge case irrelevante         |

### Steps e contextos dentro dos testes

```python
import allure

# Passo nomeado no relat√≥rio
with allure.step("Criar usu√°rio administrador"):
    post_json(request, "/usuarios", new_user)

# Decorator de step reutiliz√°vel em fun√ß√µes helper
@allure.step("Fazer login e obter token")
def get_token(request, email, password):
    resp = post_json(request, "/login", {"email": email, "password": password})
    return resp.json()["authorization"]
```

### Anexar evid√™ncias ao relat√≥rio

```python
import allure, json

# Texto puro
allure.attach("Corpo da resposta: ...", name="Response body", attachment_type=allure.attachment_type.TEXT)

# JSON formatado
allure.attach(json.dumps(body, indent=2), name="Response JSON", attachment_type=allure.attachment_type.JSON)

# Outros tipos dispon√≠veis em allure.attachment_type:
# TEXT, JSON, XML, HTML, PNG, JPG, MP4, CSV, URI_LIST, ...
```

### Exemplo completo de um teste anotado

```python
import allure
from assertpy import assert_that

@allure.epic("Autentica√ß√£o")
@allure.feature("Login")
@allure.story("Login com credenciais v√°lidas")
@allure.severity(allure.severity_level.CRITICAL)
@allure.title("CT01 - Login v√°lido retorna token JWT")
@allure.tag("smoke", "regression")
def test_ct01_valid_login_returns_token(api_request):
    with allure.step("Enviar requisi√ß√£o de login com credenciais v√°lidas"):
        resp = post_json(api_request, "/login", {"email": "user@qa.com", "password": "Senha@123"})

    with allure.step("Validar status 200 e presen√ßa do token"):
        assert_that(resp.status).is_equal_to(200)
        body = parse_response_body(resp)
        assert_that(body.get("authorization")).is_not_none()
```

---

## Observa√ß√µes gerais

- Os cen√°rios cobrem fluxos positivos (happy path), negativos e de valida√ß√£o de regras de neg√≥cio da API ServeRest.
- A su√≠te usa `APIRequestContext` do Playwright para chamadas HTTP ‚Äî sem browser, apenas HTTP client.
- Dados din√¢micos (e-mails, nomes, produtos) s√£o gerados em `tests/utils/faker_utils.py` para evitar conflitos entre execu√ß√µes.
- Fixtures de escopo `session` mant√™m a inst√¢ncia do Playwright aberta durante toda a execu√ß√£o; fixtures de escopo `function` criam e descartam o contexto HTTP por teste, garantindo isolamento.
